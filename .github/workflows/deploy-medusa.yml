name: Deploy

on:
  push:
    branches: ["main"]

concurrency:
  group: medusa-deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write
  deployments: write

env:
  NODE_VERSION: 20
  PNPM_VERSION: 10.18.2

jobs:
  build:
    name: Build Docker image
    uses: ./.github/workflows/_build-docker.yml
    with:
      app: medusa
      dockerfile: ./apps/medusa/Dockerfile
    secrets:
      database_url: ${{ secrets.DATABASE_URL }}
      database_ssl: ${{ secrets.DATABASE_SSL || 'false' }}

  deploy-qa:
    name: Deploy to QA
    needs: build
    uses: ./.github/workflows/_deploy-render.yml
    with:
      environment_name: qa
      deploy_label: QA
      service_name: gfed-medusa-backend-qa
      image: ${{ needs.build.outputs.image_tag }}
    secrets:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY}}

  deploy-prod:
    name: Deploy to Production
    needs: deploy-qa
    uses: ./.github/workflows/_deploy-render.yml
    with:
      environment_name: production
      deploy_label: Production
      service_name: gfed-medusa-backend-prod
      image: ${{ needs.build.outputs.image_tag }}
    secrets:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY}}
