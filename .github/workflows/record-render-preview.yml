name: Record Render Preview

on:
  workflow_run:
    workflows: ["CI - Medusa"]
    types: [completed]

jobs:
  record-preview:
    name: Record preview comment
    if: github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      issues: write
    steps:
      - name: Download preview metadata artifact
        id: download
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            const { owner, repo } = context.repo;
            const runId = context.payload.workflow_run.id;

            const artifacts = await github.paginate(
              github.rest.actions.listWorkflowRunArtifacts,
              {
                owner,
                repo,
                run_id: runId,
                per_page: 100,
              }
            );

            const artifact = artifacts.find(
              (item) => item.name === "render-preview-metadata" && !item.expired
            );

            if (!artifact) {
              core.notice("No preview metadata artifact found; skipping.");
              return;
            }

            const { data } = await github.rest.actions.downloadArtifact({
              owner,
              repo,
              artifact_id: artifact.id,
              archive_format: "zip",
            });

            const zipPath = path.join(process.env.RUNNER_TEMP, "render-preview-metadata.zip");
            fs.writeFileSync(zipPath, Buffer.from(data));
            core.setOutput("zip_path", zipPath);

      - name: Extract preview metadata
        if: steps.download.outputs.zip_path != ''
        env:
          ZIP_PATH: ${{ steps.download.outputs.zip_path }}
        run: |
          set -euo pipefail
          mkdir -p preview-metadata
          unzip -o "$ZIP_PATH" -d preview-metadata

      - name: Upsert preview comment
        if: steps.download.outputs.zip_path != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            const metadataPath = path.join(
              process.env.GITHUB_WORKSPACE,
              "preview-metadata",
              "render-preview.json"
            );

            if (!fs.existsSync(metadataPath)) {
              core.notice("Preview metadata file not found; skipping.");
              return;
            }

            const data = JSON.parse(fs.readFileSync(metadataPath, "utf8"));
            const previewUrl = data.preview_url || "";
            const previewServiceId = data.preview_service_id;
            const issueNumber = data.pr_number;

            if (!issueNumber || !previewServiceId) {
              core.notice("Preview metadata incomplete; skipping.");
              return;
            }

            const markerPrefix = "render-preview-service-id:";
            const { owner, repo } = context.repo;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: issueNumber,
              per_page: 100,
            });

            const matchingComments = comments.filter(
              (comment) => comment.body && comment.body.includes(markerPrefix)
            );
            const existing = matchingComments.length
              ? matchingComments[matchingComments.length - 1]
              : null;

            const extractIds = (body) => {
              const ids = new Set();
              if (!body) {
                return ids;
              }
              for (const match of body.matchAll(/render-preview-service-id:([A-Za-z0-9-]+)/g)) {
                ids.add(match[1]);
              }
              return ids;
            };

            const existingIds = new Set();
            for (const comment of matchingComments) {
              for (const id of extractIds(comment.body)) {
                existingIds.add(id);
              }
            }
            existingIds.add(previewServiceId);

            const markerLines = Array.from(existingIds).map(
              (id) => `<!-- ${markerPrefix}${id} -->`
            );
            const bodyLines = [
              "Render preview:",
              "",
              previewUrl ? `URL: ${previewUrl}` : "URL: pending",
              "",
              ...markerLines,
            ];
            const body = bodyLines.join("\n");

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
              core.notice("Updated preview metadata comment.");
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body,
              });
              core.notice("Created preview metadata comment.");
            }
